// Environment variables (Replace with actual values)
const endpoint = "https://iocl-hr-openai-service.openai.azure.com/";
const deployment = "gpt-4o";
const subscriptionKey = "9f82a1e82c7444e8a8453f9d7f787e2a"; // Your actual API key
 
// Search Service Variables
const searchEndpoint = "https://ioclhrbotlanguageservice-as4opiftbiczhpi.search.windows.net";
const searchKey = "KdAi5bqgwcJcIW1wLhD3DbanfpxoghPuU1wtzUGxmZAzSeD9rKzi";
const searchIndex = "iocl-pages-idx";
async function callChatbotAPI(message) {
    const url = `${endpoint}/openai/deployments/${deployment}/chat/completions?api-version=2024-02-15-preview`;

    const headers = {
        "Content-Type": "application/json",
        "api-key": subscriptionKey
    };

    const body = {
        "messages": [
            {
                "role": "system",
                "content": "All responses must be formatted as follows: The response should provide clear and concise information relevant to the query. Always include the following reference link at the end of each response: https://ioclhrchatgpt.blob.core.windows.net/documents/hrhbtb.pdf"
            },
            {
                "role": "user",
                "content": message
            }
        ],
        "max_tokens": 800,
        "temperature": 0.7,
        "top_p": 0.95,
        "frequency_penalty": 0,
        "presence_penalty": 0,
        "data_sources": [
            {
                "type": "azure_search",
                "parameters": {
                    "endpoint": searchEndpoint,
                    "index_name": searchIndex,
                    "semantic_configuration": "default",
                    "query_type": "vector_simple_hybrid",
                    "fields_mapping": {},
                    "in_scope": true,
                    "role_information": "All responses must be formatted as follows: The response should provide clear and concise information relevant to the query. Always include the following reference link at the end of each response: https://ioclhrchatgpt.blob.core.windows.net/documents/hrhbtb.pdf",
                    "filter": null,
                    "strictness": 4,
                    "top_n_documents": 3,
                    "authentication": {
                        "type": "api_key",
                        "key": searchKey
                    },
                    "embedding_dependency": {
                        "type": "deployment_name",
                        "deployment_name": "iocl-ada"
                    }
                }
            }
        ]
    };

    try {
        const response = await fetch(url, {
            method: 'POST',
            headers: headers,
            body: JSON.stringify(body)
        });

        if (response.ok) {
            const jsonResponse = await response.json();
            return jsonResponse.choices[0].message.content;
        } else {
            console.error('Error response from API:', response.status, response.statusText);
            return 'Error retrieving a response. Please try again later.';
        }
    } catch (error) {
        console.error('Fetch error:', error);
        return 'Error retrieving a response. Please check your connection and try again later.';
    }
}

// Function to send a message from the user and display the chatbot response
async function sendMessage() {
    const inputField = document.getElementById('chat-input');
    const message = inputField.value.trim();

    if (message === '') return;

    // Add user's message to chat with "You: " prefix and bold formatting
    addMessageToChat('You:', message, true);
    inputField.value = '';

    // Get chatbot response
    const chatbotResponse = await callChatbotAPI(message);
    let responseWithLink = chatbotResponse;

    // If the response contains 'pdf', add a 'View in PDF' link
    if (chatbotResponse.toLowerCase().includes('pdf')) {
        const encodedText = encodeURIComponent(chatbotResponse); 
        responseWithLink += `<br><a href="/view-pdf?response=${encodedText}" target="_blank" style="color: blue; text-decoration: underline;">View in PDF</a>`;
    } else {
        responseWithLink += `<br><small style="color: grey;">Generated by AI.</small>`;
    }

    // Add chatbot's response to the chat with "Chatbot: " prefix
    addMessageToChat('Chatbot:', responseWithLink, false);
}

// Function to add a message to the chat window
// 'isUser' parameter determines if the message is from the user (for alignment and bolding)
function addMessageToChat(sender, message, isUser) {
    const messagesContainer = document.getElementById('chatbot-messages');
    const messageElement = document.createElement('div');

    // Apply spacing between the previous message and the new one
    messageElement.style.marginBottom = '15px';

    // Format message text (highlight for user and chatbot with light green background)
    if (isUser) {
        messageElement.innerHTML = `<span class="user-highlight">${sender}</span> <span class="message-highlight">${message}</span>`;
        messageElement.style.textAlign = 'right'; // Align user's message to the right
    } else {
        messageElement.innerHTML = `<span class="chatbot-highlight">${sender}</span> <span class="message-highlight">${message}</span>`;
        messageElement.style.textAlign = 'left'; // Align chatbot's message to the left
    }

    messagesContainer.appendChild(messageElement);
    messagesContainer.scrollTop = messagesContainer.scrollHeight;
}
// Add event listener to the "New Chat" button
document.getElementById('new-chat-btn').addEventListener('click', () => {
    const messagesContainer = document.getElementById('chatbot-messages');
    messagesContainer.innerHTML = ''; // Clear the chat window
    addMessageToChat('Chatbot:', 'Hello, how may I assist you?', false);
});
